import React, { useEffect, useState } from 'react'
import { Table, Button, Modal, Form, Input, Select, message, Upload, Space, Tag, Drawer, Descriptions } from 'antd'
import { PlusOutlined, UploadOutlined, DeleteOutlined, EditOutlined, EyeOutlined } from '@ant-design/icons'
import { uploadRules, getRules, deleteRules, toggleRules, getRuleContent } from '../services/rules'

const { TextArea } = Input

const RuleManagement: React.FC = () => {
  const [rules, setRules] = useState<any[]>([])
  const [loading, setLoading] = useState(false)
  const [modalVisible, setModalVisible] = useState(false)
  const [editingRule, setEditingRule] = useState<any>(null)
  const [form] = Form.useForm()
  const [detailDrawerVisible, setDetailDrawerVisible] = useState(false)
  const [currentRuleContent, setCurrentRuleContent] = useState<any>(null)
  const [loadingContent, setLoadingContent] = useState(false)

  useEffect(() => {
    loadRules()
  }, [])

  const loadRules = async () => {
    setLoading(true)
    try {
      const data = await getRules()
      setRules(data)
    } catch (error) {
      message.error('åŠ è½½è§„åˆ™å¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  const handleCreate = () => {
    setEditingRule(null)
    form.resetFields()
    setModalVisible(true)
  }

  const handleEdit = (record: any) => {
    setEditingRule(record)
    form.setFieldsValue(record)
    setModalVisible(true)
  }

  const handleDelete = async (id: number) => {
    try {
      await deleteRules([id])
      message.success('åˆ é™¤æˆåŠŸ')
      loadRules()
    } catch (error) {
      message.error('åˆ é™¤å¤±è´¥')
    }
  }

  const handleSubmit = async (values: any) => {
    try {
      if (editingRule) {
        // TODO: å®ç°æ›´æ–°è§„åˆ™API
        message.warning('æ›´æ–°åŠŸèƒ½å¾…å®ç°')
      } else {
        // TODO: å®ç°åˆ›å»ºè§„åˆ™API
        message.warning('åˆ›å»ºåŠŸèƒ½å¾…å®ç°')
      }
      setModalVisible(false)
      loadRules()
    } catch (error: any) {
      message.error(error.response?.data?.detail || 'æ“ä½œå¤±è´¥')
    }
  }

  const handleUpload = async (file: any) => {
    try {
      const result = await uploadRules([file])
      message.success(`ä¸Šä¼ æˆåŠŸ: ${result.message}`)
      // ç«‹å³åˆ·æ–°è§„åˆ™åˆ—è¡¨
      setTimeout(() => loadRules(), 500)
    } catch (error: any) {
      message.error(error.response?.data?.detail || error.message || 'ä¸Šä¼ å¤±è´¥')
      console.error('ä¸Šä¼ é”™è¯¯:', error)
    }
    
    return false
  }
  
  const handleToggle = async (id: number, currentActive: boolean) => {
    try {
      await toggleRules([id])
      message.success(`å·²${currentActive ? 'ç¦ç”¨' : 'å¯ç”¨'}è§„åˆ™`)
      loadRules()
    } catch (error: any) {
      message.error('åˆ‡æ¢çŠ¶æ€å¤±è´¥')
    }
  }

  const handleViewDetail = async (ruleId: number) => {
    setLoadingContent(true)
    setDetailDrawerVisible(true)
    try {
      const content = await getRuleContent(ruleId)
      setCurrentRuleContent(content)
    } catch (error: any) {
      message.error('è·å–è§„åˆ™å†…å®¹å¤±è´¥')
      setDetailDrawerVisible(false)
    } finally {
      setLoadingContent(false)
    }
  }

  const columns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 80,
    },
    {
      title: 'è§„åˆ™åç§°',
      dataIndex: 'name',
      key: 'name',
    },
    {
      title: 'ä½œè€…',
      dataIndex: 'author',
      key: 'author',
      render: (text: string) => text || '-',
    },
    {
      title: 'æè¿°',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (text: string) => text || '-',
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'created_at',
      key: 'created_at',
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'active',
      key: 'active',
      render: (active: boolean) => (
        <Tag color={active ? 'green' : 'default'}>
          {active ? 'å¯ç”¨' : 'ç¦ç”¨'}
        </Tag>
      )
    },
    {
      title: 'æ–‡ä»¶è·¯å¾„',
      dataIndex: 'path',
      key: 'path',
      ellipsis: true,
      width: 250,
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 280,
      render: (_: any, record: any) => (
        <Space>
          <Button
            type="link"
            size="small"
            icon={<EyeOutlined />}
            onClick={() => handleViewDetail(record.id)}
          >
            æŸ¥çœ‹è¯¦æƒ…
          </Button>
          <Button
            type="link"
            size="small"
            onClick={() => handleToggle(record.id, record.active)}
          >
            {record.active ? 'ç¦ç”¨' : 'å¯ç”¨'}
          </Button>
          <Button
            type="link"
            size="small"
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record.id)}
          >
            åˆ é™¤
          </Button>
        </Space>
      ),
    },
  ]

  return (
    <div>
      <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <h2>YARA è§„åˆ™ç®¡ç†</h2>
        <Space>
          <Button onClick={loadRules} icon={<UploadOutlined />}>åˆ·æ–°åˆ—è¡¨</Button>
          <Upload 
            beforeUpload={handleUpload} 
            showUploadList={false}
            accept=".yar,.yara"
            multiple
          >
            <Button type="primary" icon={<UploadOutlined />}>
              ä¸Šä¼  YARA è§„åˆ™
            </Button>
          </Upload>
        </Space>
      </div>

      <div style={{ marginBottom: 16, padding: '12px', background: '#f0f2f5', borderRadius: '4px' }}>
        <Space direction="vertical" style={{ width: '100%' }}>
          <div>ğŸ“‹ <strong>è§„åˆ™æ€»æ•°:</strong> {rules.length} æ¡</div>
          <div>âœ… <strong>å·²å¯ç”¨:</strong> {rules.filter(r => r.active).length} æ¡</div>
          <div>âŒ <strong>å·²ç¦ç”¨:</strong> {rules.filter(r => !r.active).length} æ¡</div>
        </Space>
      </div>

      <Table
        columns={columns}
        dataSource={rules}
        loading={loading}
        rowKey="id"
        pagination={{ pageSize: 10 }}
        scroll={{ x: 1200 }}
      />

      <Drawer
        title="è§„åˆ™è¯¦æƒ…"
        width={800}
        open={detailDrawerVisible}
        onClose={() => setDetailDrawerVisible(false)}
        loading={loadingContent}
      >
        {currentRuleContent && (
          <Space direction="vertical" style={{ width: '100%' }} size="large">
            <Descriptions bordered column={1}>
              <Descriptions.Item label="è§„åˆ™ID">{currentRuleContent.id}</Descriptions.Item>
              <Descriptions.Item label="è§„åˆ™åç§°">{currentRuleContent.name}</Descriptions.Item>
              <Descriptions.Item label="çŠ¶æ€">
                <Tag color={currentRuleContent.active ? 'green' : 'default'}>
                  {currentRuleContent.active ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="æ–‡ä»¶è·¯å¾„">{currentRuleContent.path}</Descriptions.Item>
            </Descriptions>

            {currentRuleContent.meta && Object.keys(currentRuleContent.meta).length > 0 && (
              <>
                <h4>å…ƒæ•°æ®</h4>
                <Descriptions bordered column={1}>
                  {Object.entries(currentRuleContent.meta).map(([key, value]) => (
                    <Descriptions.Item key={key} label={key}>
                      {value as string}
                    </Descriptions.Item>
                  ))}
                </Descriptions>
              </>
            )}

            <div>
              <h4>è§„åˆ™å†…å®¹</h4>
              <TextArea
                value={currentRuleContent.content}
                readOnly
                autoSize={{ minRows: 15, maxRows: 30 }}
                style={{ 
                  fontFamily: 'monospace', 
                  fontSize: '13px',
                  backgroundColor: '#f5f5f5'
                }}
              />
            </div>
          </Space>
        )}
      </Drawer>

      <Modal
        title={editingRule ? 'ç¼–è¾‘è§„åˆ™' : 'æ–°å»ºè§„åˆ™'}
        open={modalVisible}
        onCancel={() => setModalVisible(false)}
        onOk={() => form.submit()}
        width={800}
      >
        <Form form={form} onFinish={handleSubmit} layout="vertical">
          <Form.Item
            name="name"
            label="è§„åˆ™åç§°"
            rules={[{ required: true, message: 'è¯·è¾“å…¥è§„åˆ™åç§°' }]}
          >
            <Input placeholder="ä¾‹å¦‚: malware_detection_rule" />
          </Form.Item>

          <Form.Item name="description" label="æè¿°">
            <Input.TextArea rows={2} placeholder="è§„åˆ™æè¿°" />
          </Form.Item>

          <Form.Item
            name="content"
            label="è§„åˆ™å†…å®¹"
            rules={[{ required: true, message: 'è¯·è¾“å…¥è§„åˆ™å†…å®¹' }]}
          >
            <TextArea rows={10} placeholder="è¾“å…¥ YARA è§„åˆ™..." />
          </Form.Item>

          <Form.Item name="category" label="åˆ†ç±»">
            <Input placeholder="ä¾‹å¦‚: trojan, ransomware" />
          </Form.Item>

          <Form.Item name="tags" label="æ ‡ç­¾">
            <Input placeholder="å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”" />
          </Form.Item>

          <Form.Item name="severity" label="ä¸¥é‡ç¨‹åº¦">
            <Select>
              <Select.Option value="low">Low</Select.Option>
              <Select.Option value="medium">Medium</Select.Option>
              <Select.Option value="high">High</Select.Option>
              <Select.Option value="critical">Critical</Select.Option>
            </Select>
          </Form.Item>

          <Form.Item name="author" label="ä½œè€…">
            <Input placeholder="è§„åˆ™ä½œè€…" />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default RuleManagement
