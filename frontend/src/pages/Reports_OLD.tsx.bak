import React, { useEffect, useState } from 'react'
import { Card, Row, Col, Spin, message, Empty } from 'antd'
import { 
  LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer 
} from 'recharts'
import api from '../services/api'

interface TrendData {
  date: string
  total: number
  malicious: number
  clean: number
}

interface RuleEffectiveness {
  name: string
  matches: number
}

interface StatsData {
  total_scans: number
  malicious_count: number
  clean_count: number
}

const Reports: React.FC = () => {
  const [loading, setLoading] = useState(false)
  const [trendData, setTrendData] = useState<TrendData[]>([])
  const [ruleData, setRuleData] = useState<RuleEffectiveness[]>([])
  const [statsData, setStatsData] = useState<StatsData | null>(null)

  useEffect(() => {
    loadData()
  }, [])

  const loadData = async () => {
    setLoading(true)
    try {
      const [trend, rules, stats] = await Promise.all([
        api.get('/api/reports/trend?days=7').then(res => res.data),
        api.get('/api/reports/rule-effectiveness').then(res => res.data),
        api.get('/api/reports/stats').then(res => res.data)
      ])
      setTrendData(trend)
      setRuleData(rules)
      setStatsData(stats)
    } catch (error: any) {
      message.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥')
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  const COLORS = ['#52c41a', '#ff4d4f', '#faad14', '#1890ff', '#722ed1']

  const pieData = statsData ? [
    { name: 'æ£€æµ‹åˆ°å¨èƒ', value: statsData.malicious_count },
    { name: 'æœªå‘ç°å¨èƒ', value: statsData.clean_count }
  ] : []

  return (
    <div>
      <h2>æ£€æµ‹æŠ¥å‘Šä¸ç»Ÿè®¡</h2>
      
      <Spin spinning={loading}>
        <Row gutter={[16, 16]}>
          {/* æ‰«æè¶‹åŠ¿å›¾ */}
          <Col span={24}>
            <Card title="ğŸ“ˆ æ‰«æè¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰">
              {trendData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <LineChart data={trendData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line 
                      type="monotone" 
                      dataKey="total" 
                      stroke="#1890ff" 
                      name="æ€»æ‰«ææ•°"
                      strokeWidth={2}
                    />
                    <Line 
                      type="monotone" 
                      dataKey="malicious" 
                      stroke="#ff4d4f" 
                      name="æ£€æµ‹åˆ°å¨èƒ"
                      strokeWidth={2}
                    />
                    <Line 
                      type="monotone" 
                      dataKey="clean" 
                      stroke="#52c41a" 
                      name="æœªå‘ç°å¨èƒ"
                      strokeWidth={2}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <Empty description="æš‚æ— è¶‹åŠ¿æ•°æ®" />
              )}
            </Card>
          </Col>

          {/* å¨èƒç±»å‹åˆ†å¸ƒ */}
          <Col xs={24} lg={12}>
            <Card title="ğŸ›¡ï¸ æ£€æµ‹ç»“æœåˆ†å¸ƒ">
              {pieData.length > 0 && (pieData[0].value > 0 || pieData[1].value > 0) ? (
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={(entry) => `${entry.name}: ${entry.value}`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={index === 0 ? '#ff4d4f' : '#52c41a'} />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <Empty description="æš‚æ— æ£€æµ‹æ•°æ®" />
              )}
            </Card>
          </Col>

          {/* è§„åˆ™æœ‰æ•ˆæ€§åˆ†æ */}
          <Col xs={24} lg={12}>
            <Card title="ğŸ“Š è§„åˆ™æœ‰æ•ˆæ€§æ’è¡Œï¼ˆTop 10ï¼‰">
              {ruleData.length > 0 ? (
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={ruleData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis 
                      dataKey="name" 
                      angle={-45}
                      textAnchor="end"
                      height={100}
                      interval={0}
                    />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="matches" fill="#1890ff" name="åŒ¹é…æ¬¡æ•°" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <Empty description="æš‚æ— è§„åˆ™ç»Ÿè®¡æ•°æ®" />
              )}
            </Card>
          </Col>
        </Row>
      </Spin>
    </div>
  )
}

export default Reports
